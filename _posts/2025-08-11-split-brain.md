---
layout: post
title:  脑裂问题
date:   2025-08-11 19:27:25
categories: 高可用
tags: 脑裂问题
---

* content
{:toc}

脑裂，顾名思义就是“大脑分裂”。在分布式系统中，它指的是原本应该只有一个主节点（Leader或Master）却因为网络故障或节点异常，出现了多个主节点，导致系统行为混乱。

假设你有一个 ZooKeeper 或 Redis 集群，正常情况下只有一个主节点负责写操作。但如果网络分区发生，两个子集群可能各自选出一个主节点，同时对外提供服务，这就造成了脑裂。

在业界中常用两种做法，第一种方法，叫规定叫法定人数，一个经典实现就是在 redis sentinel。我们在业务处理的时候，额外的构建一套监控节点。每一个监控节点都会向每一台我们的主从服务器定时的发起心跳包来探测他们的可用状态。假设在我们实际应用过程中，发现有些节点无法正常的通信，当达到一个指定的数量以后，我们就认为这个集群是失效的。

这是我们说到的第一种常见的脑裂的情况，引入一个监控节点来进行一个观测，这种设计目前是越来越少了，更多的是主流的采用投票的选举算法来决定我们的网络分区情况。

选举算法在行业中非常的普遍，尤其是在分布式的情况下，采用多数投票的机制来确保大多数的节点决策达成一致，这可以规避因为节点丢失产生的脑裂的问题，常用的算法比较很多，比如说paxos，raft等等，但他们统一的一个规则就是，如果在我们进行应用的时候，有过半数的节点有效的话，那么我们的这个集群就认为是有效的，如果没有过半数，那么剩余的就是无效的。

如何预防脑裂？
不同系统有不同的策略，以下是通用和典型的解决方案：

1. 过半原则（Quorum）
例如 ZooKeeper 要求超过半数节点参与选举，才能产生新的 Leader。

如果某个分区节点数不足半数，则无法选举 Leader，从而避免脑裂。

2. 保护模式（Redis）
Redis 3.2 引入了 protected-mode，在检测到脑裂时阻止主节点接受写请求。

3. 分布式锁机制（如 Redlock）
用于确保多个数据中心之间的一致性，防止多个主节点同时写入。

4. 合理部署节点数量
推荐使用奇数节点（如 3、5、7），以便更容易达成过半投票。

5. 网络优化与监控
保持网络稳定，及时发现分区故障，避免误判。
