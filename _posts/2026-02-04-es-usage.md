---
layout: post
title:  ElasticSearch 使用
date:   2026-02-04 11:22:45
categories: ES
tags: ES
---

* content
{:toc}

一般读写 ES 分为 3 步：创建 Mapping、写入数据、查询数据。

1. mapping

``PUT http://192.168.30.138:9200/filetrack_idx``

``` json
{
	"settings": {
		"analysis": {
			"tokenizer": {
				"my_ngram_tokenizer": {
					"type": "ngram",
					"min_gram": 1,
					"max_gram": 1,
					"token_chars": [
						"letter",
						"digit"
					]
				}
			},
			"analyzer": {
				"my_ngram_analyzer": {
					"type": "custom",
					"tokenizer": "my_ngram_tokenizer"
				},
				"my_search_analyzer": {
					"type": "custom",
					"tokenizer": "standard",
					"filter": []
				}
			}
		}
	},
	"mappings": {
		"dynamic": "strict",
		"properties": {
			"filename": {
				"type": "text",
				"analyzer": "my_ngram_analyzer",
				"search_analyzer": "my_search_analyzer"
			},
			"circulationtime": {
				"type": "date",
				"format": "epoch_millis"
			},
			"computerid": {
				"type": "keyword"
			}
		}
	}
}
```

2. 写入数据

``POST http://192.168.30.138:9200/filetrack_idx/_doc/00_176``
``` json
{
  "filename": "04 温湿度腔体采购合同-超滑所-20240111.pdf",
	"computerid": 10022,
	"circulationtime": 1712802477
}
```

``` c++
    int64_t totalCount = 0;
    for (auto i = 0; i < 0x1f; i++)
    {
        char szTabName[128] {0x00};
        sprintf(szTabName, "docrootlog_%02x", i);

        char szBuff[512] {0x00};

        int retryTime = 0;
        int64_t nBeginId = 0;
        while(true)
        {
            int rowCount = 0;
            CTrdbRecordSet trRs;
            ITrdbHelper* pHelper = trRs.getHelper(szTabName);
            pHelper->select("id, filename, circulationtime, computerid");
            pHelper->where("id > %" PRId64, nBeginId);
            //(翻页查询)每次拿取1k数据生成索引
            pHelper->limit(0, 200);

            if (0 != trRs.execQuery(0, "dlp_filetrack"))
            {
                retryTime++;
                continue;
            }

            if(3 < retryTime)
                break;
            
            std::string req;
            while (!trRs.isEof())
	        {
                nBeginId = trRs.getInt64Value(0);
                memset(szBuff, 0x00, 512);
                sprintf(szBuff, R"({"index": {"_id": "%02x_%ld"}})", i, nBeginId);
                req += szBuff;
                req += "\n";

                memset(szBuff, 0x00, 512);
                sprintf(szBuff, R"({"filename":"%s","circulationtime":%ld,"computerid":%d})", trRs.getStringValue(1), trRs.getInt64Value(2), trRs.getIntValue(3));
                req += szBuff;
                req += "\n";
                totalCount++;
                rowCount++;
                trRs.next();
            }

            curl_easy_setopt(curl, CURLOPT_URL, "http://192.168.30.138:9200/filetrack_idx/_bulk");
            curl_easy_setopt(curl, CURLOPT_POST, 1L); 
            curl_easy_setopt(curl, CURLOPT_POSTFIELDS, req.c_str());

            // 必须使用 application/x-ndjson
            struct curl_slist* headers = nullptr;
            headers = curl_slist_append(headers, "Content-Type: application/x-ndjson");
            headers = curl_slist_append(headers, "Connection: keep-alive");
            curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);

            CURLcode res = curl_easy_perform(curl);

            if (res != CURLE_OK)
            {
                std::cerr << "Bulk request failed: " << curl_easy_strerror(res) << std::endl;
            }
            else
            {
                fprintf(stdout, "Bulk request success.\n");
            }

            curl_slist_free_all(headers);

            if (rowCount < 200)
                break;
        }
    }

    fprintf(stdout, "done! total%ld\n", totalCount);

    curl_easy_cleanup(curl);
    curl_global_cleanup();
```

3. 查询

``GET http://192.168.30.138:9200/filetrack_idx/_search``

``` json
{
	"size": 10,
	"sort": [
		{
			"circulationtime": {
				"order": "desc"
			}
		}
	],
	"query": {
		"bool": {
			"must": [
				{
					"match": {
						"filename": "采购"
					}
				}
			],
			"filter": [
				{
					"term": {
						"computerid": "10022"
					}
				},
				{
					"range": {
						"circulationtime": {
							"gte": "1704038400",
							"lte": "1804038400"
						}
					}
				}
			]
		}
	}
}
```