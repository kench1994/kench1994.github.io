---
layout: post
title:  mysql 断点恢复
date:   2023-09-10 19:32:25
categories: database
tags: mysql
---

* content
{:toc}

**【表象】** mysql服务不断重启
**【系统日志】** 事件查看器 - windows日志 - 系统  中可以看到 Kernel-Power 系统断电关键错误
**【mysql日志】** mysql errlog 
``` shell
2023-07-18T16:32:03.299099+08:00 0 [Note] InnoDB: Log scan progressed past the checkpoint lsn 32973622
2023-07-18T16:32:03.299552+08:00 0 [Note] InnoDB: Doing recovery: scanned up to log sequence number 32973631
2023-07-18T16:32:03.299919+08:00 0 [Note] InnoDB: Database was not shutdown normally!
2023-07-18T16:32:03.300210+08:00 0 [Note] InnoDB: Starting crash recovery.
2023-07-18T16:32:03.495797+08:00 0 [Warning] InnoDB: Database page corruption or a failed file read of page [page id: space=0, page number=671]. Trying to recover it from the doublewrite buffer.
2023-07-18T16:32:03.502719+08:00 0 [Note] InnoDB: Recovered page [page id: space=0, page number=671] from the doublewrite buffer.
2023-07-18T16:32:04.934707+08:00 0 [Warning] InnoDB: Database page corruption or a failed file read of page [page id: space=0, page number=675]. Trying to recover it from the doublewrite buffer.
2023-07-18T16:32:04.937939+08:00 0 [Note] InnoDB: Recovered page [page id: space=0, page number=675] from the doublewrite buffer.
2023-07-18T16:32:10.294706+08:00 0 [ERROR] InnoDB: Page [page id: space=0, page number=281] log sequence number 32974098 is in the future! Current system log sequence number 32973640.
2023-07-18T16:32:10.297668+08:00 0 [ERROR] InnoDB: Your database may be corrupt or you may have copied the InnoDB tablespace but not the InnoDB log files. Please refer to http://dev.mysql.com/doc/refman/5.7/en/forcing-innodb-recovery.html for information about forcing recovery.
2023-07-18T16:32:10.386026+08:00 0 [ERROR] InnoDB: Page [page id: space=0, page number=282] log sequence number 32974418 is in the future! Current system log sequence number 32973640.
2023-07-18T16:32:10.387275+08:00 0 [ERROR] InnoDB: Your database may be corrupt or you may have copied the InnoDB tablespace but not the InnoDB log files. Please refer to http://dev.mysql.com/doc/refman/5.7/en/forcing-innodb-recovery.html for information about forcing recovery.
2023-07-18T16:32:10.438780+08:00 0 [ERROR] InnoDB: Database page corruption on disk or a failed file read of page [page id: space=0, page number=51]. You may have to recover from a backup.
2023-07-18T16:32:10.439535+08:00 0 [Note] InnoDB: Page dump in ascii and hex (16384 bytes):
```

> 通过errlog可知，数据库没有正常关闭，并且开始进行崩溃恢复操作，但实际恢复过程中发现数据库可能存在损坏，并且导致程序抛出异常并异常退出

#### 【解决方法】
1. 停止daemon和所有用到mysql的服务
2. 备份 mysql data 目录（或者整个mysql目录也行）
3. 将 mysql data 目录导入本地测试机（非生产运行环境）
4. 找到 mysql 配置文件文件，添加以下参数，尝试 ``innodb_force_recovery 1 ~ 6`` 进行启动MySQL，直到能成功启动为止
``` shell
   [mysqld]
   innodb_force_recovery=1 (这个值越小越安全,最开始建议设置为1，如果也无法启动再改为2，以此类推，最大值为6)
```

5. 重新启动 mysql 之后表都是只读状态，此时可以备份数据库

6. 提供以下一键备份脚本 ``backup.sh``

``` shell
#!/bin/bash

now_dir=`pwd`
# 备份文件的保存目录
backup_dir="$now_dir/dbak/"

# MySQL的用户名和密码
mysql_host="127.0.0.1"
mysql_port=23306
mysql_user="root"
mysql_password=""

# 获取当前日期作为备份文件名的一部分
backup_date=$(date +%Y%m%d)

# 创建备份目录（如果不存在）
mkdir -p $backup_dir


cd bin
# 获取所有数据库列表
databases=$(./mysql -P23306 -u $mysql_user -p$mysql_password -e "SHOW DATABASES;" | grep -Ev "(Database|information_schema|performance_schema|mysql)")

# 循环备份每个数据库
for db in $databases; do
    backup_file="$backup_dir/$db-$backup_date.sql.gz"
    ./mysqldump -h$mysql_host -P$mysql_port -u $mysql_user -p$mysql_password $db | gzip > $backup_file
done
```

7. 删除 data 目录下的对应的数据库目录和 ``ib*`` 文件
``` shell
cp /data/mysql/data/ib_logfile0 /data/mysql/backup/
cp /data/mysql/data/ib_logfile1 /data/mysql/backup/
cp /data/mysql/data/ib_logfile2 /data/mysql/backup/
cp /data/mysql/data/ib_logfile3 /data/mysql/backup/
cp /data/mysql/data/ibdata1 /data/mysql/backup/
rm -rf /data/mysql/data/ib_logfile0
rm -rf /data/mysql/data/ib_logfile1
rm -rf /data/mysql/data/ib_logfile2
rm -rf /data/mysql/data/ib_logfile3
rm -rf /data/mysql/data/ibdata1
```

8. 关闭 innodb_force_recovery 选项，重新启动 mysql

9. 运行恢复脚本恢复导出数据
``` shell
#!/bin/bash

now_dir=`pwd`
# 备份文件的保存目录
backup_dir="$now_dir/dbak/"

# MySQL的用户名和密码
mysql_host="127.0.0.1"
mysql_port=23306
mysql_user="root"
mysql_password=""

# 获取需要恢复的备份文件
backup_files=$(ls -t $backup_dir/*.sql.gz)

cd bin

# 循环处理每个备份文件
for backup_file in $backup_files; do
    echo "正在恢复备份文件: $backup_file"
    
    # 提取数据库名称（从文件名中去除路径和文件扩展名）
    db=$(basename $backup_file | sed 's/\(.*\)-[0-9]*\.sql\.gz/\1/')
    
    # 创建数据库（如果不存在）
    ./mysql -h$mysql_host -P$mysql_port -u $mysql_user -p$mysql_password -e "CREATE DATABASE IF NOT EXISTS $db;"
    
    # 执行恢复操作
    gzip -dkc $backup_file | ./mysql -h$mysql_host -P$mysql_port -u $mysql_user -p$mysql_password $db
    
    echo "恢复完成: $db"
done
```
10. 将恢复好的 数据库data 和 ib* 文件拷贝会生产运行环境
11. 启动数据库、daemon及其他服务   

#### 【其他】
这边是 ``innodb_force_recovery`` 的枚举值定义，越高的值越危险，并可能造成永久性的损坏
||||
| :-- | :- | :- |
1 | (SRV_FORCE_IGNORE_CORRUPT)| 忽略检查到的corrupt页。 
2 | (SRV_FORCE_NO_BACKGROUND)  | 阻止主线程的运行，如主线程需要执行full purge操作，会导致crash
3 | (SRV_FORCE_NO_TRX_UNDO)| 不执行事务回滚操作。
4 | (SRV_FORCE_NO_IBUF_MERGE)  | 不执行插入缓冲的合并操作。 
5 | (SRV_FORCE_NO_UNDO_LOG_SCAN) | 不查看重做日志，InnoDB存储引擎会将未提交的事务视为已提交。 
6 | (SRV_FORCE_NO_LOG_REDO) | 不执行前滚的操作

  

如果你能以innodb_force_recovery为3或更低值恢复/转储你的表时，这种情况库还相对安全的，因为只在相对独立的页上的一些数据会丢失。innodb_force_recovery>4时，数据库损坏度比较大/危险，因为数据文件被永久地损坏。值6被认为是严重的，数据库页被留在一个陈旧的状态，这反过来又可能带给B-trees和其它数据库结构更多的损坏。

如果异常等级更大，可以参考这边文章的思路定位损坏的表https://blog.51cto.com/u_8026776/4827637


-----------------

https://cn.pingcap.com/article/post/2326.html
https://bbs.huaweicloud.com/blogs/366435
https://www.modb.pro/db/128847
https://www.wxhmf.com/posts/how-to-fix-innodb-error-log-sequence-number-is-in-the-future/
https://blog.51cto.com/u_8026776/4827637